<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuuna AI</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500&display=swap');

        :root {
            --primary-color: #00f3ff;
            --secondary-color: #bc13fe;
            --bg-color: #050510;
            --glass-bg: rgba(255, 255, 255, 0.05);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: white;
            font-family: 'Rajdhani', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* Background Grid Animation */
        .grid-bg {
            position: absolute;
            width: 200%;
            height: 200%;
            background-image:
                linear-gradient(rgba(0, 243, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            transform: perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px);
            animation: gridMove 20s linear infinite;
            z-index: -1;
        }

        @keyframes gridMove {
            0% {
                transform: perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px);
            }

            100% {
                transform: perspective(500px) rotateX(60deg) translateY(50px) translateZ(-200px);
            }
        }

        .container {
            text-align: center;
            z-index: 1;
            width: 100%;
            max-width: 800px;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 3rem;
            /* Reduced size */
            margin-bottom: 5px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0, 243, 255, 0.5);
            letter-spacing: 5px;
        }

        .status-text {
            font-size: 1.2rem;
            /* Reduced size */
            color: #aaa;
            margin-bottom: 20px;
            /* Reduced margin */
            min-height: 25px;
        }

        /* The Core / Orb */
        .orb-container {
            position: relative;
            width: 150px;
            /* Reduced size */
            height: 150px;
            /* Reduced size */
            margin: 0 auto 30px;
            /* Reduced margin */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .orb {
            width: 90px;
            /* Reduced size */
            height: 90px;
            /* Reduced size */
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, var(--primary-color), #000);
            box-shadow:
                0 0 30px var(--primary-color),
                0 0 60px var(--secondary-color),
                inset 0 0 20px rgba(255, 255, 255, 0.5);
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }

        .orb.listening {
            animation: pulse 1.5s infinite alternate;
            box-shadow:
                0 0 50px var(--primary-color),
                0 0 100px var(--secondary-color);
        }

        .orb.speaking {
            animation: speak 0.2s infinite alternate;
            background: radial-gradient(circle at 30% 30%, var(--secondary-color), #000);
        }

        /* Rings around the orb */
        .ring {
            position: absolute;
            border-radius: 50%;
            border: 2px solid transparent;
            border-top-color: var(--primary-color);
            border-bottom-color: var(--secondary-color);
            animation: spin 4s linear infinite;
        }

        .ring:nth-child(1) {
            width: 120px;
            /* Reduced size */
            height: 120px;
            /* Reduced size */
            animation-duration: 4s;
        }

        .ring:nth-child(2) {
            width: 140px;
            /* Reduced size */
            height: 140px;
            /* Reduced size */
            animation-duration: 7s;
            border-width: 1px;
            animation-direction: reverse;
        }

        .ring:nth-child(3) {
            width: 170px;
            /* Reduced size */
            height: 170px;
            /* Reduced size */
            animation-duration: 12s;
            border-top-color: transparent;
            border-left-color: var(--primary-color);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            100% {
                transform: scale(1.1);
            }
        }

        @keyframes speak {
            0% {
                transform: scale(0.95);
                opacity: 0.8;
            }

            100% {
                transform: scale(1.05);
                opacity: 1;
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .chat-log {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            width: 80%;
            margin: 0 auto;
            height: 120px;
            /* Reduced height */
            overflow-y: auto;
            text-align: left;
            font-family: 'Courier New', monospace;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .log-entry {
            margin-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 4px;
            font-size: 0.9rem;
        }

        .user-msg {
            color: var(--primary-color);
        }

        .system-msg {
            color: var(--secondary-color);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .controls {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        button {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 16px;
            /* Reduced padding */
            font-family: 'Orbitron', sans-serif;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 0.9rem;
        }

        button:hover {
            background: var(--primary-color);
            color: black;
            box-shadow: 0 0 20px var(--primary-color);
        }

        select {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--secondary-color);
            color: white;
            padding: 6px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            border-radius: 5px;
            outline: none;
            width: 100%;
            max-width: 300px;
            cursor: pointer;
        }

        select option {
            background: #050510;
            color: white;
        }
    </style>
</head>

<body>

    <div class="grid-bg"></div>

    <div class="container">
        <h1>TUUNA</h1>
        <div class="status-text" id="status">Initializing System...</div>

        <div class="orb-container">
            <div class="ring"></div>
            <div class="ring"></div>
            <div class="ring"></div>
            <div class="orb" id="orb"></div>
        </div>

        <!-- Manual Input for Debugging -->
        <div style="margin-bottom: 15px;">
            <input type="text" id="manualInput" placeholder="Type command here..."
                style="padding: 8px; width: 250px; border-radius: 5px; border: none;">
            <button onclick="sendManualCommand()">Send</button>
        </div>

        <div class="chat-log" id="chatLog">
            <div class="log-entry system-msg">> System Online. Waiting for command...</div>
        </div>

        <div class="controls">
            <select id="voiceSelect" onchange="testVoice()">
                <option value="">Loading Voices...</option>
            </select>
            <div class="button-group">
                <button id="startBtn" onclick="activateTuuna()">Start Listening</button>
                <button onclick="toggleHelp()">Commands</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal"
        style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); border: 1px solid var(--primary-color); padding: 20px; border-radius: 10px; z-index: 100; width: 80%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
        <h2 style="color: var(--primary-color); margin-top: 0;">Voice Commands</h2>
        <div style="text-align: left; line-height: 1.6;">
            <strong>System:</strong> "Shutdown system", "Restart system", "Sleep mode", "Empty recycle bin", "Battery
            status"<br>
            <strong>Mouse:</strong> "Move mouse up/down/left/right", "Click", "Right click", "Scroll up/down"<br>
            <strong>Keyboard:</strong> "Type [text]", "Press enter/space/escape", "Copy", "Paste", "Select all"<br>
            <strong>Windows:</strong> "Switch window", "Minimize window", "Maximize window", "Close window"<br>
            <strong>Files:</strong> "Open file [name]" (Searches Desktop/Docs/Downloads)<br>
            <strong>Apps:</strong> "Open calculator", "Open notepad", "Open google", "Open youtube"<br>
            <strong>Media:</strong> "Play [song] on youtube", "Volume up", "Volume down", "Mute"<br>
            <strong>Knowledge:</strong> "Who is [name]", "Tell me about [topic]", "Search for [query]"<br>
        </div>
        <button onclick="toggleHelp()" style="margin-top: 20px; width: 100%;">Close</button>
    </div>

    <script>
        const orb = document.getElementById('orb');
        const statusText = document.getElementById('status');
        const chatLog = document.getElementById('chatLog');
        const manualInput = document.getElementById('manualInput');
        const helpModal = document.getElementById('helpModal');
        const voiceSelect = document.getElementById('voiceSelect');

        let voices = [];

        function populateVoices() {
            const allVoices = window.speechSynthesis.getVoices();
            voiceSelect.innerHTML = '';
            voices = [];

            allVoices.forEach((voice) => {
                // Filter for English, Hindi, and Indian languages
                const lang = voice.lang.toLowerCase();
                const name = voice.name.toLowerCase();

                if (lang.startsWith('en') || lang.startsWith('hi') || name.includes('india') || name.includes('hindi')) {
                    voices.push(voice);
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.value = voice.name; // Use name as value for easier lookup

                    if (voice.default) {
                        option.textContent += ' -- DEFAULT';
                    }

                    option.setAttribute('data-lang', voice.lang);
                    option.setAttribute('data-name', voice.name);
                    voiceSelect.appendChild(option);
                }
            });

            if (voices.length === 0) {
                const option = document.createElement('option');
                option.textContent = "No matching voices found";
                voiceSelect.appendChild(option);
            }

            // Try to select a good default if available
            const preferredIndex = voices.findIndex(voice => voice.name.includes('Google US English') || voice.name.includes('Zira'));
            if (preferredIndex !== -1) {
                voiceSelect.selectedIndex = preferredIndex;
            }
        }

        populateVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoices;
        }

        function testVoice() {
            // Optional: Speak a short phrase when voice changes to confirm selection
            // speak("Voice changed."); 
        }

        function toggleHelp() {
            if (helpModal.style.display === 'none') {
                helpModal.style.display = 'block';
            } else {
                helpModal.style.display = 'none';
            }
        }

        // Speech Recognition Setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (!SpeechRecognition) {
            alert("Your browser does not support Speech Recognition. Please use Google Chrome.");
        }

        const recognition = new SpeechRecognition();

        recognition.continuous = true; // Keep listening
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        let isListening = false;
        let isSpeaking = false;

        // Wake Word
        const WAKE_WORD = "tuuna";

        recognition.onstart = () => {
            statusText.innerText = "Listening... Say 'Hey Tuuna'";
            orb.classList.remove('speaking');
            orb.classList.add('listening');
            isListening = true;
            document.getElementById('startBtn').innerText = "Stop Listening";
            document.getElementById('startBtn').onclick = stopTuuna;
        };

        recognition.onend = () => {
            isListening = false;
            orb.classList.remove('listening');
            statusText.innerText = "Paused. Click Start to resume.";
            document.getElementById('startBtn').innerText = "Start Listening";
            document.getElementById('startBtn').onclick = activateTuuna;
        };

        recognition.onerror = (event) => {
            console.error("Speech Error:", event.error);
            statusText.innerText = "Error: " + event.error;
        };

        recognition.onresult = (event) => {
            const lastResult = event.results[event.results.length - 1];
            const transcript = lastResult[0].transcript.trim().toLowerCase();

            console.log("Heard:", transcript);
            logMessage("Heard", transcript, true);

            // List of trigger words that should activate the assistant even without "Tuuna"
            const actionTriggers = ["open", "play", "what", "who", "tell", "search", "google", "youtube", "time", "date", "shutdown", "restart", "sleep", "move", "click", "scroll", "type", "press", "copy", "paste", "switch", "minimize", "maximize", "close", "volume", "mute", "battery", "empty"];

            // Common misspellings of Tuuna
            const wakeWordVariations = ["tuuna", "tuna", "tuner", "toona", "two na"];

            const hasWakeWord = wakeWordVariations.some(w => transcript.includes(w));
            const hasActionTrigger = actionTriggers.some(t => transcript.startsWith(t));

            if (hasWakeWord || hasActionTrigger) {
                // Clean up the command
                let command = transcript;
                wakeWordVariations.forEach(w => { command = command.replace(w, ""); });
                command = command.replace("hey", "").trim();

                if (command) {
                    processCommand(command);
                } else {
                    speak("Yes? I'm listening.");
                }
            }
        };

        function logMessage(sender, text, isDebug = false) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            if (isDebug) {
                entry.style.color = '#555'; // Dim color for raw hearing
                entry.innerHTML = `<span style="color: #777">>> Raw:</span> ${text}`;
            } else {
                entry.innerHTML = `<span class="${sender === 'User' ? 'user-msg' : 'system-msg'}">> ${sender}:</span> ${text}`;
            }
            chatLog.appendChild(entry);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        function sendManualCommand() {
            const text = manualInput.value;
            if (text) {
                logMessage("User", text);
                processCommand(text);
                manualInput.value = "";
            }
        }

        async function processCommand(command) {
            statusText.innerText = "Processing...";

            try {
                const response = await fetch('http://localhost:5000/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: command })
                });

                const data = await response.json();
                logMessage("Tuuna", data.response);
                speak(data.response);

            } catch (error) {
                console.error("Error:", error);
                logMessage("System", "Error connecting to server. Is python server.py running?");
                speak("I cannot connect to the server.");
            }

            statusText.innerText = "Listening...";
        }

        function speak(text) {
            isSpeaking = true;
            recognition.stop(); // Stop listening while speaking

            orb.classList.add('speaking');
            statusText.innerText = "Speaking...";

            const utterance = new SpeechSynthesisUtterance(text);

            // Use selected voice
            if (voiceSelect.selectedOptions.length > 0) {
                const selectedOption = voiceSelect.selectedOptions[0].getAttribute('data-name');
                const allVoices = window.speechSynthesis.getVoices();
                const selectedVoice = allVoices.find(voice => voice.name === selectedOption);

                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }
            }

            utterance.onend = () => {
                isSpeaking = false;
                orb.classList.remove('speaking');
                statusText.innerText = "Listening...";
                // Resume listening after speaking
                activateTuuna();
            };

            window.speechSynthesis.speak(utterance);
        }

        function activateTuuna() {
            try {
                recognition.start();
            } catch (e) {
                console.log("Already started or error:", e);
            }
        }

        function stopTuuna() {
            recognition.stop();
        }

        // Allow 'Enter' key in input
        manualInput.addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                sendManualCommand();
            }
        });

    </script>
</body>

</html>